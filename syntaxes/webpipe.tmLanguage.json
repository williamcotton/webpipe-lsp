{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "Web Pipe",
  "scopeName": "source.webpipe",
  "fileTypes": [
    "wp"
  ],
  "patterns": [
    {
      "include": "#comments"
    },
    {
      "include": "#config-definition"
    },
    {
      "include": "#route-definition"
    },
    {
      "include": "#variable-assignment"
    },
    {
      "include": "#test-spec-keywords"
    },
    {
      "include": "#assertion-output-jq"
    },
    {
      "include": "#backtick-json"
    },
    {
      "include": "#triple-quote-strings"
    }
    ,
    {
      "include": "#general-numbers"
    }
  ],
  "repository": {
    "comments": {
      "patterns": [
        {
          "name": "comment.line.number-sign.webpipe",
          "match": "#.*$"
        }
      ]
    },
    "config-definition": {
      "patterns": [
        {
          "begin": "^\\s*(config)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*\\{",
          "beginCaptures": {
            "1": {
              "name": "keyword.control.config.webpipe"
            },
            "2": {
              "name": "entity.name.type.config.webpipe"
            }
          },
          "end": "\\}",
          "name": "meta.config-block.webpipe",
          "patterns": [
            {
              "include": "#config-content"
            }
          ]
        }
      ]
    },
    "route-definition": {
      "patterns": [
        {
          "begin": "^\\s*(GET|POST|PUT|PATCH|DELETE)\\s+([^\\s]+)",
          "beginCaptures": {
            "1": {
              "name": "keyword.control.http-method.webpipe"
            },
            "2": {
              "name": "string.unquoted.route-path.webpipe",
              "patterns": [
                {
                  "match": ":[a-zA-Z_][a-zA-Z0-9_]*",
                  "name": "variable.parameter.route.webpipe"
                }
              ]
            }
          },
          "end": "^(?!\\s*\\|>)(?=\\S|$)",
          "patterns": [
            {
              "include": "#comments"
            },
            {
              "include": "#pipeline-steps"
            }
          ]
        }
      ]
    },
    "variable-assignment": {
      "patterns": [
        {
          "begin": "^\\s*(graphql)\\s+(schema)\\s*=\\s*`",
          "beginCaptures": {
            "1": {
              "name": "storage.type.graphql.webpipe"
            },
            "2": {
              "name": "keyword.control.graphql.webpipe"
            }
          },
          "end": "`",
          "name": "meta.graphql-schema.webpipe",
          "contentName": "source.graphql",
          "patterns": [
            {
              "include": "source.graphql"
            }
          ]
        },
        {
          "begin": "^\\s*(query)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*=",
          "beginCaptures": {
            "1": {
              "name": "storage.type.graphql.query.webpipe"
            },
            "2": {
              "name": "entity.name.function.query.webpipe"
            }
          },
          "end": "^(?!\\s*\\|>)(?=\\S|$)",
          "name": "meta.query-resolver.webpipe",
          "patterns": [
            {
              "include": "#comments"
            },
            {
              "include": "#pipeline-steps"
            }
          ]
        },
        {
          "begin": "^\\s*(mutation)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*=",
          "beginCaptures": {
            "1": {
              "name": "storage.type.graphql.mutation.webpipe"
            },
            "2": {
              "name": "entity.name.function.mutation.webpipe"
            }
          },
          "end": "^(?!\\s*\\|>)(?=\\S|$)",
          "name": "meta.mutation-resolver.webpipe",
          "patterns": [
            {
              "include": "#comments"
            },
            {
              "include": "#pipeline-steps"
            }
          ]
        },
        {
          "begin": "^\\s*(pipeline)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*=",
          "beginCaptures": {
            "1": {
              "name": "storage.type.middleware.webpipe"
            },
            "2": {
              "name": "variable.other.assignment.webpipe"
            }
          },
          "end": "^(?!\\s*\\|>)(?=\\S|$)",
          "name": "meta.variable-assignment.pipeline.webpipe",
          "patterns": [
            {
              "include": "#comments"
            },
            {
              "include": "#pipeline-steps"
            }
          ]
        },
        {
          "begin": "^\\s*(jq)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*`",
          "beginCaptures": {
            "1": {
              "name": "storage.type.middleware.webpipe"
            },
            "2": {
              "name": "variable.other.assignment.webpipe"
            }
          },
          "end": "`",
          "name": "meta.variable-assignment.jq.webpipe",
          "contentName": "source.jq",
          "patterns": [
            {
              "include": "#jq-embedded"
            }
          ]
        },
        {
          "begin": "^\\s*(lua)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*`",
          "beginCaptures": {
            "1": {
              "name": "storage.type.middleware.webpipe"
            },
            "2": {
              "name": "variable.other.assignment.webpipe"
            }
          },
          "end": "`",
          "name": "meta.variable-assignment.lua.webpipe",
          "contentName": "source.lua",
          "patterns": [
            {
              "include": "source.lua"
            }
          ]
        },
        {
          "begin": "^\\s*(pg)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*`",
          "beginCaptures": {
            "1": {
              "name": "storage.type.middleware.webpipe"
            },
            "2": {
              "name": "variable.other.assignment.webpipe"
            }
          },
          "end": "`",
          "name": "meta.variable-assignment.sql.webpipe",
          "contentName": "source.sql",
          "patterns": [
            {
              "include": "#sql-string-override"
            },
            {
              "include": "source.sql"
            }
          ]
        },
        {
          "begin": "^\\s*(mustache)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*`",
          "beginCaptures": {
            "1": {
              "name": "storage.type.middleware.webpipe"
            },
            "2": {
              "name": "variable.other.assignment.webpipe"
            }
          },
          "end": "`",
          "name": "meta.variable-assignment.mustache.webpipe",
          "contentName": "text.html.mustache",
          "patterns": [
            {
              "include": "#mustache-embedded"
            }
          ]
        },
        {
          "begin": "^\\s*(mustache)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*\"\"\"",
          "beginCaptures": {
            "1": {
              "name": "storage.type.middleware.webpipe"
            },
            "2": {
              "name": "variable.other.assignment.webpipe"
            }
          },
          "end": "\"\"\"",
          "name": "meta.variable-assignment.mustache.triple.webpipe",
          "contentName": "text.html.mustache",
          "patterns": [
            {
              "include": "#mustache-embedded"
            }
          ]
        },
        {
          "begin": "^\\s*(handlebars)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*`",
          "beginCaptures": {
            "1": {
              "name": "storage.type.middleware.webpipe"
            },
            "2": {
              "name": "variable.other.assignment.webpipe"
            }
          },
          "end": "`",
          "name": "meta.variable-assignment.handlebars.webpipe",
          "contentName": "text.html.mustache",
          "patterns": [
            {
              "include": "#mustache-embedded"
            }
          ]
        },
        {
          "begin": "^\\s*(validate)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*=\\s*`",
          "beginCaptures": {
            "1": {
              "name": "storage.type.middleware.webpipe"
            },
            "2": {
              "name": "variable.other.assignment.webpipe"
            }
          },
          "end": "`",
          "name": "meta.variable-assignment.validate.webpipe",
          "contentName": "source.validate.webpipe",
          "patterns": [
            {
              "include": "#validate-embedded"
            }
          ]
        }
      ]
    },
    "pipeline-steps": {
      "patterns": [
        {
          "include": "#comments"
        },
        {
          "include": "#middleware-step"
        },
        {
          "include": "#result-step"
        },
        {
          "include": "#pipeline-operator"
        },
        {
          "include": "#tags"
        }
      ]
    },
    "pipeline-operator": {
      "match": "^\\s*(\\|>)|(?<=\\s)(\\|>)",
      "captures": {
        "1": {
          "name": "keyword.operator.pipe.webpipe"
        },
        "2": {
          "name": "keyword.operator.pipe.webpipe"
        }
      }
    },
    "middleware-step": {
      "patterns": [
        {
          "begin": "^\\s*(\\|>)\\s*(jq):\\s*`",
          "beginCaptures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.jq.webpipe"
            }
          },
          "end": "`",
          "name": "meta.embedded.jq.webpipe",
          "contentName": "source.jq",
          "patterns": [
            {
              "include": "#jq-embedded"
            }
          ]
        },
        {
          "begin": "^\\s*(\\|>)\\s*(lua):\\s*`",
          "beginCaptures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.lua.webpipe"
            }
          },
          "end": "`",
          "name": "meta.embedded.lua.webpipe",
          "contentName": "source.lua",
          "patterns": [
            {
              "include": "source.lua"
            }
          ]
        },
        {
          "begin": "^\\s*(\\|>)\\s*(pg):\\s*`",
          "beginCaptures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.pg.webpipe"
            }
          },
          "end": "`",
          "name": "meta.embedded.sql.webpipe",
          "contentName": "source.sql",
          "patterns": [
            {
              "include": "#sql-string-override"
            },
            {
              "include": "source.sql"
            }
          ]
        },
        {
          "begin": "^\\s*(\\|>)\\s*(mustache):\\s*`",
          "beginCaptures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.mustache.webpipe"
            }
          },
          "end": "`",
          "name": "meta.embedded.mustache.webpipe",
          "contentName": "text.html.mustache",
          "patterns": [
            {
              "include": "#mustache-embedded"
            }
          ]
        },
        {
          "begin": "^\\s*(\\|>)\\s*(handlebars):\\s*`",
          "beginCaptures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.handlebars.webpipe"
            }
          },
          "end": "`",
          "name": "meta.embedded.handlebars.webpipe",
          "contentName": "text.html.mustache",
          "patterns": [
            {
              "include": "#mustache-embedded"
            }
          ]
        },
        {
          "begin": "^\\s*(\\|>)\\s*(validate):\\s*`",
          "beginCaptures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.validate.webpipe"
            }
          },
          "end": "`",
          "name": "meta.embedded.validate.webpipe",
          "contentName": "source.validate.webpipe",
          "patterns": [
            {
              "include": "#validate-embedded"
            }
          ]
        },
        {
          "begin": "^\\s*(\\|>)\\s*(graphql):\\s*`",
          "beginCaptures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.graphql.webpipe"
            }
          },
          "end": "`",
          "name": "meta.embedded.graphql.webpipe",
          "contentName": "source.graphql",
          "patterns": [
            {
              "include": "source.graphql"
            }
          ]
        },
        {
          "begin": "^\\s*(\\|>)\\s*(join):\\s*`",
          "beginCaptures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.join.webpipe"
            }
          },
          "end": "`",
          "name": "meta.embedded.join.webpipe",
          "patterns": [
            {
              "include": "#join-config"
            }
          ]
        },
        {
          "begin": "^\\s*(\\|>)\\s*(join):\\s*\"",
          "beginCaptures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.join.webpipe"
            }
          },
          "end": "\"",
          "name": "meta.embedded.join.webpipe",
          "patterns": [
            {
              "include": "#join-config"
            }
          ]
        },
        {
          "match": "^\\s*(\\|>)\\s*([a-zA-Z_][a-zA-Z0-9_]*):\\s*`",
          "captures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.webpipe"
            }
          }
        },
        {
          "match": "^\\s*(\\|>)\\s*([a-zA-Z_][a-zA-Z0-9_]*):\\s*([a-zA-Z_][a-zA-Z0-9_]*)(?!\\s*`)",
          "captures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.webpipe"
            },
            "3": {
              "name": "variable.other.webpipe"
            }
          }
        },
        {
          "match": "^\\s*(\\|>)\\s*([a-zA-Z_][a-zA-Z0-9_]*):\\s*\"([^\"]+)\"",
          "captures": {
            "1": {
              "name": "keyword.operator.pipe.webpipe"
            },
            "2": {
              "name": "entity.name.function.middleware.webpipe"
            },
            "3": {
              "name": "string.quoted.double.webpipe"
            }
          }
        }
      ]
    },
    "result-step": {
      "begin": "^\\s*(\\|>)\\s*(result)\\s*$",
      "beginCaptures": {
        "1": {
          "name": "keyword.operator.pipe.webpipe"
        },
        "2": {
          "name": "keyword.control.result.webpipe"
        }
      },
      "end": "^(?!\\s*[a-zA-Z]+\\(\\d+\\):)(?!\\s*\\|>)(?=\\S|$)",
      "patterns": [
        {
          "include": "#result-conditions"
        }
      ]
    },
    "result-conditions": {
      "patterns": [
        {
          "begin": "^\\s*([a-zA-Z]+)\\((\\d+)\\):",
          "beginCaptures": {
            "1": {
              "name": "entity.name.type.condition.webpipe"
            },
            "2": {
              "name": "constant.numeric.status-code.webpipe"
            }
          },
          "end": "^(?=\\s*[a-zA-Z]+\\(\\d+\\):|^(?!\\s*\\|>)\\S|$)",
          "patterns": [
            {
              "include": "#comments"
            },
            {
              "include": "#pipeline-steps"
            }
          ]
        }
      ]
    },
    "jq-embedded": {
      "patterns": [
        {
          "name": "string.quoted.double.jq",
          "begin": "\"",
          "end": "(\"|(?=`))",
          "endCaptures": {
            "1": {
              "name": "punctuation.definition.string.end.jq"
            }
          },
          "patterns": [
            {
              "name": "constant.character.escape.jq",
              "match": "\\\\."
            }
          ]
        },
        {
          "name": "variable.other.jq",
          "match": "\\.[a-zA-Z_][a-zA-Z0-9_]*|\\.[0-9]+"
        },
        {
          "name": "variable.parameter.jq",
          "match": "\\$[a-zA-Z_][a-zA-Z0-9_]*"
        },
        {
          "name": "keyword.operator.jq",
          "match": "\\||\\+|\\-|\\*|/|==|!=|<|>|<=|>=|and|or|not|\\?"
        },
        {
          "name": "support.function.jq",
          "match": "\\b(map|select|keys|values|length|tostring|tonumber|type|now|empty|error|debug|reverse|sort|group_by|unique|flatten|min|max|add|any|all|range|floor|ceil|round|sqrt|test|match|capture|split|join|ltrimstr|rtrimstr|startswith|endswith|inside|contains|index|rindex|tojson|fromjson|@\\w+)\\b"
        },
        {
          "name": "constant.language.jq",
          "match": "\\b(null|true|false)\\b"
        },
        {
          "name": "constant.numeric.jq",
          "match": "\\b[0-9]+\\.?[0-9]*\\b"
        },
        {
          "name": "meta.brackets.jq",
          "begin": "\\[",
          "end": "(\\]|(?=`))",
          "patterns": [
            {
              "include": "#jq-embedded"
            }
          ]
        },
        {
          "name": "meta.braces.jq",
          "begin": "\\{",
          "end": "(\\}|(?=`))",
          "patterns": [
            {
              "include": "#jq-embedded"
            }
          ]
        }
      ]
    },
    "mustache-embedded": {
      "patterns": [
        {
          "include": "text.html.basic"
        },
        {
          "name": "meta.tag.mustache.triple",
          "begin": "\\{\\{\\{",
          "end": "(\\}\\}\\}|(?=`))",
          "beginCaptures": {
            "0": {
              "name": "punctuation.definition.tag.begin.mustache"
            }
          },
          "endCaptures": {
            "1": {
              "name": "punctuation.definition.tag.end.mustache"
            }
          },
          "contentName": "variable.other.mustache"
        },
        {
          "name": "meta.tag.mustache",
          "begin": "\\{\\{",
          "end": "(\\}\\}|(?=`))",
          "beginCaptures": {
            "0": {
              "name": "punctuation.definition.tag.begin.mustache"
            }
          },
          "endCaptures": {
            "1": {
              "name": "punctuation.definition.tag.end.mustache"
            }
          },
          "patterns": [
            {
              "match": "^\\s*(#|\\^|/|>|&|!)",
              "name": "keyword.control.mustache"
            },
            {
              "match": "[a-zA-Z_][a-zA-Z0-9_]*",
              "name": "variable.other.mustache"
            }
          ]
        }
      ]
    },
    "sql-string-override": {
      "patterns": [
        {
          "name": "string.quoted.single.sql",
          "begin": "'",
          "end": "('|(?=`))",
          "patterns": [
            {
              "name": "constant.character.escape.sql",
              "match": "\\\\.|''"
            }
          ]
        },
        {
          "name": "string.quoted.double.sql",
          "begin": "\"",
          "end": "(\"|(?=`))",
          "patterns": [
            {
              "name": "constant.character.escape.sql",
              "match": "\\\\.\"|\"\""
            }
          ]
        }
      ]
    },
    "validate-embedded": {
      "patterns": [
        {
          "match": "^\\s*([a-zA-Z_][a-zA-Z0-9_]*)(\\?)?\\s*:\\s*(.+)$",
          "captures": {
            "1": {
              "name": "variable.parameter.field.validate"
            },
            "2": {
              "name": "keyword.operator.optional.validate"
            },
            "3": {
              "name": "meta.type.validate",
              "patterns": [
                {
                  "include": "#validate-types"
                }
              ]
            }
          }
        }
      ]
    },
    "validate-types": {
      "patterns": [
        {
          "match": "\\b(string|number|email|boolean)\\b",
          "name": "support.type.validate"
        },
        {
          "match": "\\(\\s*(\\d+)\\s*\\.\\.\\s*(\\d+)\\s*\\)",
          "captures": {
            "1": {
              "name": "constant.numeric.min.validate"
            },
            "2": {
              "name": "constant.numeric.max.validate"
            }
          }
        }
      ]
    },
    "config-content": {
      "patterns": [
        {
          "match": "^\\s*([a-zA-Z_][a-zA-Z0-9_]*)\\s*:",
          "captures": {
            "1": {
              "name": "variable.parameter.config-key.webpipe"
            }
          }
        },
        {
          "name": "variable.other.environment.webpipe",
          "match": "\\$[a-zA-Z_][a-zA-Z0-9_]*"
        },
        {
          "name": "keyword.operator.fallback.webpipe",
          "match": "\\|\\|"
        },
        {
          "name": "string.quoted.double.webpipe",
          "begin": "\"",
          "end": "\"",
          "patterns": [
            {
              "name": "constant.character.escape.webpipe",
              "match": "\\\\."
            }
          ]
        },
        {
          "name": "constant.language.boolean.webpipe",
          "match": "\\b(true|false)\\b"
        },
        {
          "name": "constant.numeric.webpipe",
          "match": "\\b[0-9]+\\.?[0-9]*\\b"
        },
        {
          "name": "meta.object.config.webpipe",
          "begin": "\\{",
          "end": "\\}",
          "patterns": [
            {
              "include": "#config-content"
            }
          ]
        }
      ]
    },
    "test-spec-keywords": {
      "patterns": [
        {
          "match": "\\b(describe|it)\\s+(\"[^\"]*\")",
          "captures": {
            "1": {
              "name": "keyword.control.bdd.webpipe"
            },
            "2": {
              "name": "string.quoted.double.webpipe"
            }
          }
        },
        {
          "name": "keyword.control.bdd.webpipe",
          "match": "\\b(describe|it|with|when|then|and)\\b"
        },
        {
          "name": "keyword.control.bdd.helper.webpipe",
          "match": "\\b(executing|calling|input|output|contentType|equals|contains|matches|in|status|mock|returning)\\b"
        }
      ]
    },
    "assertion-output-jq": {
      "patterns": [
        {
          "begin": "^\\s*(then|and)\\s+(output)\\s*`",
          "beginCaptures": {
            "1": { "name": "keyword.control.bdd.webpipe" },
            "2": { "name": "keyword.control.bdd.helper.webpipe" }
          },
          "end": "`",
          "name": "meta.assertion.output.jq.webpipe",
          "contentName": "source.jq",
          "patterns": [
            { "include": "#jq-embedded" }
          ]
        }
      ]
    },
    "backtick-json": {
      "patterns": [
        {
          "begin": "`",
          "end": "`",
          "name": "meta.embedded.json.webpipe",
          "contentName": "source.json",
          "patterns": [
            {
              "include": "source.json"
            }
          ]
        }
      ]
    },
    "triple-quote-strings": {
      "patterns": [
        {
          "begin": "\"\"\"",
          "end": "\"\"\"",
          "name": "string.quoted.triple.webpipe",
          "patterns": [
            {
              "name": "variable.other.webpipe",
              "match": "\\.[a-zA-Z_][a-zA-Z0-9_]*"
            }
          ]
        }
      ]
    },
    "embedded-content": {
      "patterns": [
        {
          "match": ".+",
          "name": "string.unquoted.embedded.webpipe"
        }
      ]
    },
    "tags": {
      "patterns": [
        {
          "name": "storage.modifier.tag.webpipe",
          "match": "@!?[a-zA-Z_][a-zA-Z0-9_-]*(\\((\\s*[a-zA-Z0-9_-]+\\s*)(,\\s*[a-zA-Z0-9_-]+\\s*)*\\))?"
        }
      ]
    },
    "join-config": {
      "patterns": [
        {
          "name": "punctuation.separator.comma.webpipe",
          "match": ","
        },
        {
          "name": "punctuation.bracket.square.webpipe",
          "match": "[\\[\\]]"
        },
        {
          "name": "variable.other.async-task.webpipe",
          "match": "\"([a-zA-Z_][a-zA-Z0-9_-]*)\"",
          "captures": {
            "1": {
              "name": "variable.other.async-task.webpipe"
            }
          }
        },
        {
          "name": "variable.other.async-task.webpipe",
          "match": "'([a-zA-Z_][a-zA-Z0-9_-]*)'",
          "captures": {
            "1": {
              "name": "variable.other.async-task.webpipe"
            }
          }
        },
        {
          "name": "variable.other.async-task.webpipe",
          "match": "\\b[a-zA-Z_][a-zA-Z0-9_-]*\\b"
        }
      ]
    },
    "general-numbers": {
      "patterns": [
        {
          "name": "constant.numeric.webpipe",
          "match": "\\b[0-9]+(\\.[0-9]+)?\\b"
        }
      ]
    }
  }
}